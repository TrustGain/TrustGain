<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>TRUST GAIN | COMMAND CENTER (ROOT)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root { 
            --gold: #FFD700; 
            --gold-dark: #B8860B;
            --bg-dark: #020202; 
            --surface: rgba(20, 20, 20, 0.85);
            --border: rgba(255, 215, 0, 0.15); 
        }
        
        body { 
            background: var(--bg-dark); 
            color: #fff; 
            font-family: 'Poppins', sans-serif; 
            min-height: 100vh;
            background-image: radial-gradient(circle at top right, rgba(255, 215, 0, 0.07), transparent 40%);
        }

        .gold-gradient-text { 
            background: linear-gradient(135deg, #FFF5B7 0%, #FFD700 50%, #B8860B 100%); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
            font-family: 'Orbitron', sans-serif; 
        }

        .glass-panel { 
            background: var(--surface); 
            backdrop-filter: blur(25px); 
            border: 1px solid var(--border); 
            border-radius: 24px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.6);
        }

        .admin-input { 
            background: rgba(255, 255, 255, 0.03); 
            border: 1px solid rgba(255, 215, 0, 0.1); 
            color: white; 
            padding: 16px; 
            border-radius: 16px; 
            outline: none; 
            width: 100%;
            transition: 0.3s;
        }
        .admin-input:focus { border-color: var(--gold); background: rgba(255, 255, 255, 0.06); }

        .btn-elite { 
            background: linear-gradient(45deg, #B8860B, #FFD700); 
            color: black; 
            font-weight: 900; 
            padding: 16px 24px; 
            border-radius: 16px; 
            text-transform: uppercase; 
            font-size: 11px;
            letter-spacing: 2px;
            transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .btn-elite:active { transform: scale(0.95); }

        .tab-btn { 
            padding: 16px 20px; 
            font-size: 10px; 
            font-weight: 900; 
            text-transform: uppercase; 
            color: #555; 
            letter-spacing: 1px;
            border-bottom: 2px solid transparent;
            transition: 0.3s;
        }
        .tab-btn.active { color: var(--gold); border-bottom-color: var(--gold); }

        .table-container { 
            overflow-x: auto; 
            scrollbar-width: thin;
            scrollbar-color: var(--gold-dark) transparent;
        }
        
        /* Mobile adjustments */
        @media (max-width: 640px) {
            .stats-grid { grid-template-columns: 1fr 1fr; }
            .stats-grid > div:last-child { grid-column: span 2; }
        }
    </style>
</head>
<body class="p-4 md:p-10">

<!-- Login Screen -->
<div id="login-screen" class="fixed inset-0 bg-[#020202] z-[9999] flex items-center justify-center hidden">
    <div class="glass-panel p-10 w-full max-w-md text-center">
        <div class="w-20 h-20 bg-yellow-500/10 rounded-full flex items-center justify-center mx-auto mb-6 border border-yellow-500/20">
            <i class="fas fa-user-shield text-3xl gold-gradient-text"></i>
        </div>
        <h2 class="text-2xl font-black gold-gradient-text mb-8 tracking-tighter">MASTER ACCESS</h2>
        <input type="password" id="admin-pass" placeholder="Enter Command Key" class="admin-input text-center">
        <button onclick="adminLogin()" class="btn-elite w-full mt-6">Authorize Control</button>
    </div>
</div>

<!-- Main Control UI -->
<div id="admin-ui" class="max-w-6xl mx-auto hidden">
    <header class="flex flex-col md:flex-row justify-between items-end mb-12 gap-8">
        <div>
            <span class="text-yellow-500 text-[10px] font-black uppercase tracking-[0.4em] mb-2 block">ðŸŒŸ System Root ðŸŒŸ</span>
            <h1 class="text-4xl font-black gold-gradient-text">COMMAND CENTER</h1>
        </div>
        <div class="stats-grid grid grid-cols-3 gap-4 w-full md:w-auto">
            <div class="glass-panel px-6 py-4 text-center">
                <span id="total-users" class="text-xl font-bold">0</span>
                <p class="text-[8px] text-gray-500 font-black uppercase">Members</p>
            </div>
            <div class="glass-panel px-6 py-4 text-center border-red-500/20">
                <span id="pending-withdraws" class="text-xl font-bold text-red-500">0</span>
                <p class="text-[8px] text-gray-500 font-black uppercase">Pending</p>
            </div>
            <div onclick="handleLogout()" class="glass-panel flex items-center justify-center px-4 cursor-pointer text-gray-600 hover:text-red-500">
                <i class="fas fa-power-off"></i>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <div class="flex border-b border-white/5 mb-10 overflow-x-auto no-scrollbar">
        <button onclick="switchTab('tab-settings')" class="tab-btn active" id="btn-tab-settings">App Parameters</button>
        <button onclick="switchTab('tab-withdrawals')" class="tab-btn" id="btn-tab-withdrawals">Financial Ledger</button>
        <button onclick="switchTab('tab-tasks')" class="tab-btn" id="btn-tab-tasks">Task Matrix</button>
        <button onclick="switchTab('tab-users')" class="tab-btn" id="btn-tab-users">User Database</button>
    </div>

    <!-- 1. App Settings Section -->
    <div id="tab-settings" class="tab-content space-y-8 animate-fadeIn">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="glass-panel p-8">
                <h3 class="text-[10px] font-black gold-gradient-text uppercase mb-8 tracking-[0.3em]">Economic Core</h3>
                <div class="space-y-6">
                    <div>
                        <label class="text-[9px] text-gray-500 uppercase font-bold ml-1">Task Reward (à§³)</label>
                        <input type="number" id="set-task-reward" class="admin-input mt-2" placeholder="0.00">
                    </div>
                    <div>
                        <label class="text-[9px] text-gray-500 uppercase font-bold ml-1">Stream Ad Reward (à§³)</label>
                        <input type="number" id="set-ad-reward" class="admin-input mt-2" placeholder="0.00">
                    </div>
                    <div>
                        <label class="text-[9px] text-gray-500 uppercase font-bold ml-1">Minimum Withdrawal (à§³)</label>
                        <input type="number" id="set-min-withdraw" class="admin-input mt-2" placeholder="50.00">
                    </div>
                    <div>
                        <label class="text-[9px] text-gray-500 uppercase font-bold ml-1">Video Ad URL (Target)</label>
                        <input type="text" id="set-ad-link" class="admin-input mt-2" placeholder="https://...">
                    </div>
                </div>
            </div>
            <div class="glass-panel p-8">
                <h3 class="text-[10px] font-black gold-gradient-text uppercase mb-8 tracking-[0.3em]">Floating Notice</h3>
                <div class="space-y-6">
                    <div>
                        <label class="text-[9px] text-gray-500 uppercase font-bold ml-1">Notice Title</label>
                        <input type="text" id="set-notice-title" class="admin-input mt-2" placeholder="ðŸŒŸ Trust Gain ðŸŒŸ">
                    </div>
                    <div>
                        <label class="text-[9px] text-gray-500 uppercase font-bold ml-1">Notice Message</label>
                        <textarea id="set-notice-text" class="admin-input mt-2 h-32" placeholder="Write the update here..."></textarea>
                    </div>
                    <div class="flex items-center gap-4 p-4 bg-white/5 rounded-2xl border border-white/5">
                        <input type="checkbox" id="set-notice-active" class="h-5 w-5 accent-yellow-500">
                        <span class="text-[10px] text-gray-400 font-black uppercase">Enable Floating Modal</span>
                    </div>
                </div>
            </div>
        </div>
        <button onclick="saveGlobalSettings()" class="btn-elite w-full py-6">Commit Global Changes</button>
    </div>

    <!-- 2. Withdrawals Section -->
    <div id="tab-withdrawals" class="tab-content hidden">
        <div class="glass-panel table-container">
            <table class="w-full text-left text-[11px]">
                <thead class="bg-white/5 text-gray-500 uppercase tracking-widest">
                    <tr>
                        <th class="p-6">Member / Method</th>
                        <th class="p-6">Requested</th>
                        <th class="p-6 text-green-500">Net Payout</th>
                        <th class="p-6 text-right">Authorize</th>
                    </tr>
                </thead>
                <tbody id="withdraw-list" class="divide-y divide-white/5">
                    <!-- Dynamic Data -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- 3. Task Matrix Section -->
    <div id="tab-tasks" class="tab-content hidden">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div class="glass-panel p-8 h-fit sticky top-10">
                <h3 class="text-[10px] font-black gold-gradient-text uppercase mb-8 tracking-[0.3em]">Task Editor</h3>
                <div class="space-y-4">
                    <select id="task-selector" onchange="loadTaskDetails()" class="admin-input text-yellow-500 font-bold"></select>
                    <input type="text" id="task-link" class="admin-input" placeholder="Execution Link">
                    <input type="text" id="task-code" class="admin-input" placeholder="Verification Token">
                    <button onclick="saveTaskDetails()" class="btn-elite w-full mt-4">Save Matrix Unit</button>
                </div>
            </div>
            <div class="md:col-span-2 glass-panel table-container max-h-[70vh]">
                <table class="w-full text-[10px] text-left">
                    <thead class="bg-white/5 sticky top-0 text-gray-500 uppercase font-black">
                        <tr><th class="p-5">ID</th><th class="p-5">Verification Code</th><th class="p-5">Status</th></tr>
                    </thead>
                    <tbody id="task-table-body" class="divide-y divide-white/5"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 4. User Vault Section -->
    <div id="tab-users" class="tab-content hidden">
        <div class="glass-panel p-10 max-w-2xl mx-auto">
            <h3 class="text-[10px] font-black gold-gradient-text uppercase mb-10 tracking-[0.3em] text-center">Member Asset Override</h3>
            <div class="space-y-6">
                <div>
                    <label class="text-[9px] text-gray-500 uppercase font-bold ml-1">Target Email</label>
                    <input type="email" id="user-email-search" class="admin-input mt-2" placeholder="user@gmail.com">
                </div>
                <div>
                    <label class="text-[9px] text-gray-500 uppercase font-bold ml-1">Set Asset Balance (à§³)</label>
                    <input type="number" id="user-balance-adjust" class="admin-input mt-2" placeholder="0.00">
                </div>
                <button onclick="updateUserBalance()" class="btn-elite w-full py-5">Override Member Assets</button>
            </div>
        </div>
    </div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, onSnapshot, updateDoc, collection, query, getDocs, deleteDoc, orderBy, setDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // Your exact Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyCIXm_8gXbAQiqK-iog_jtd7o6EiozL9oA",
        authDomain: "trustgain-9c1e9.firebaseapp.com",
        projectId: "trustgain-9c1e9",
        storageBucket: "trustgain-9c1e9.firebasestorage.app",
        messagingSenderId: "320806460423",
        appId: "1:320806460423:web:f75fe40dbe575128ecdea2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const ADMIN_EMAIL = "sabbirsir.com@gmail.com";

    onAuthStateChanged(auth, (user) => {
        if (user && user.email === ADMIN_EMAIL) {
            document.getElementById('admin-ui').classList.remove('hidden');
            document.getElementById('login-screen').classList.add('hidden');
            startSystem();
        } else {
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('admin-ui').classList.add('hidden');
        }
    });

    window.adminLogin = async () => {
        const pass = document.getElementById('admin-pass').value;
        try { await signInWithEmailAndPassword(auth, ADMIN_EMAIL, pass); } 
        catch (e) { Swal.fire('Denied', 'Invalid Master Key', 'error'); }
    };

    window.handleLogout = () => signOut(auth);

    let globalSettings = {};

    function startSystem() {
        setupTaskSelector();
        loadGlobalSettings();
        syncStats();
        loadWithdrawals();
    }

    async function syncStats() {
        const usersSnap = await getDocs(collection(db, "users"));
        document.getElementById('total-users').innerText = usersSnap.size;
        onSnapshot(collection(db, "withdraws"), s => {
            document.getElementById('pending-withdraws').innerText = s.size;
        });
    }

    function loadGlobalSettings() {
        onSnapshot(doc(db, "admin", "settings"), (s) => {
            if(s.exists()) {
                globalSettings = s.data();
                document.getElementById('set-task-reward').value = globalSettings.taskReward || 0;
                document.getElementById('set-ad-reward').value = globalSettings.adReward || 0;
                document.getElementById('set-min-withdraw').value = globalSettings.minWithdraw || 50;
                document.getElementById('set-ad-link').value = globalSettings.adLink || '';
                document.getElementById('set-notice-title').value = globalSettings.noticeTitle || '';
                document.getElementById('set-notice-text').value = globalSettings.noticeText || '';
                document.getElementById('set-notice-active').checked = globalSettings.noticeActive || false;
            }
        });
    }

    window.saveGlobalSettings = async () => {
        const data = {
            taskReward: parseFloat(document.getElementById('set-task-reward').value) || 0,
            adReward: parseFloat(document.getElementById('set-ad-reward').value) || 0,
            minWithdraw: parseFloat(document.getElementById('set-min-withdraw').value) || 50,
            adLink: document.getElementById('set-ad-link').value,
            noticeTitle: document.getElementById('set-notice-title').value,
            noticeText: document.getElementById('set-notice-text').value,
            noticeActive: document.getElementById('set-notice-active').checked
        };
        await setDoc(doc(db, "admin", "settings"), data, {merge: true});
        Swal.fire({ title: 'Deployed!', text: 'System parameters updated', icon: 'success', background: '#0a0a0a', color: '#fff' });
    };

    window.switchTab = (id) => {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.remove('hidden');
        document.getElementById('btn-' + id).classList.add('active');
        if(id === 'tab-tasks') renderTaskTable();
    };

    // --- Financial Management ---
    function loadWithdrawals() {
        onSnapshot(query(collection(db, "withdraws"), orderBy("timestamp", "desc")), s => {
            const list = document.getElementById('withdraw-list');
            list.innerHTML = "";
            s.forEach(d => {
                const data = d.data();
                list.innerHTML += `
                    <tr class="hover:bg-white/5 transition">
                        <td class="p-6">
                            <div class="font-bold text-white">${data.email}</div>
                            <div class="text-[9px] text-yellow-500 font-bold uppercase">${data.method}</div>
                        </td>
                        <td class="p-6 font-bold">${data.requested}à§³</td>
                        <td class="p-6 text-green-500 font-bold">${data.disbursed.toFixed(2)}à§³</td>
                        <td class="p-6 flex justify-end gap-3">
                            <button onclick="processWithdraw('${d.id}', 'approve')" class="h-10 w-10 rounded-xl bg-green-500/10 text-green-500 border border-green-500/20 hover:bg-green-500 hover:text-white transition">
                                <i class="fas fa-check text-[10px]"></i>
                            </button>
                            <button onclick="processWithdraw('${d.id}', 'reject', '${data.email}', ${data.requested})" class="h-10 w-10 rounded-xl bg-red-500/10 text-red-500 border border-red-500/20 hover:bg-red-500 hover:text-white transition">
                                <i class="fas fa-times text-[10px]"></i>
                            </button>
                        </td>
                    </tr>`;
            });
        });
    }

    window.processWithdraw = async (id, action, email, amt) => {
        const confirm = await Swal.fire({
            title: action === 'approve' ? 'Authorize Payment?' : 'Reject & Refund Member?',
            text: "This operation will modify user assets.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: action === 'approve' ? '#22c55e' : '#ef4444',
            background: '#0a0a0a',
            color: '#fff'
        });

        if(confirm.isConfirmed) {
            if(action === 'reject') {
                await updateDoc(doc(db, "users", email), { balance: increment(amt) });
            }
            await deleteDoc(doc(db, "withdraws", id));
            toast(action === 'approve' ? 'Payout Verified' : 'Refund Completed', 'success');
        }
    };

    // --- Task Matrix Logic ---
    function setupTaskSelector() {
        const sel = document.getElementById('task-selector');
        sel.innerHTML = `<option value="">Select Task Unit</option>`;
        for(let i=1; i<=50; i++) sel.innerHTML += `<option value="${i}">TASK UNIT #${i}</option>`;
    }

    window.loadTaskDetails = () => {
        const id = document.getElementById('task-selector').value;
        if(!id) return;
        document.getElementById('task-link').value = globalSettings[`task${id}_link`] || '';
        document.getElementById('task-code').value = globalSettings[`task${id}_code`] || '';
    };

    window.saveTaskDetails = async () => {
        const id = document.getElementById('task-selector').value;
        if(!id) return toast('Select task unit', 'error');
        await setDoc(doc(db, "admin", "settings"), {
            [`task${id}_link`]: document.getElementById('task-link').value,
            [`task${id}_code`]: document.getElementById('task-code').value
        }, {merge: true});
        toast(`Task Unit #${id} Synchronized`, 'success');
        renderTaskTable();
    };

    function renderTaskTable() {
        const body = document.getElementById('task-table-body');
        body.innerHTML = "";
        for(let i=1; i<=50; i++) {
            const code = globalSettings[`task${i}_code`];
            body.innerHTML += `
                <tr class="hover:bg-white/5">
                    <td class="p-5 font-bold text-yellow-500">UNIT #${i}</td>
                    <td class="p-5 font-mono text-gray-400">${code || 'OFFLINE'}</td>
                    <td class="p-5">
                        <span class="px-3 py-1 rounded-full text-[8px] font-black uppercase ${code ? 'bg-green-500/10 text-green-500' : 'bg-red-500/10 text-red-500'}">
                            ${code ? 'Active' : 'Missing Code'}
                        </span>
                    </td>
                </tr>`;
        }
    }

    // --- Member Vault Management ---
    window.updateUserBalance = async () => {
        const email = document.getElementById('user-email-search').value;
        const bal = parseFloat(document.getElementById('user-balance-adjust').value);
        if(!email) return toast('Target email missing', 'error');
        try {
            await updateDoc(doc(db, "users", email), { balance: bal });
            Swal.fire({ title: 'Override Successful', text: `New Balance: ${bal}à§³`, icon: 'success', background: '#0a0a0a', color: '#fff' });
        } catch (e) { toast('Member not found', 'error'); }
    };

    function toast(msg, icon) {
        Swal.fire({ text: msg, icon: icon, toast: true, position: 'top', showConfirmButton: false, timer: 3000, background: '#111', color: '#fff' });
    }
</script>
</body>
</html>